<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"always","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="张潮州">
<meta property="og:url" content="https:&#x2F;&#x2F;chaozhouzhang.github.io&#x2F;page&#x2F;2&#x2F;index.html">
<meta property="og:site_name" content="张潮州">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://chaozhouzhang.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>张潮州</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">张潮州</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/15/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/15/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/" class="post-title-link" itemprop="url">垃圾收集</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-15 16:28:04 / Modified: 23:22:34" itemprop="dateCreated datePublished" datetime="2020-01-15T16:28:04+08:00">2020-01-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java和C++的区别：内存动态分配和垃圾收集技术。</span><br><span class="line">排查内存泄露、内存溢出。</span><br><span class="line"></span><br><span class="line">Java内存运行时区域的各个部分，其中程序计数器、虚拟机栈、本地方法栈3个区域随线程而生，随线程而灭；栈中的栈帧随着方法的进入和退出而有条不紊地执行着出栈和入栈操作。每一个栈帧中分配多少内存基本上是在类结构确定下来时就已知的，因此这几个区域的内存分配和回收都具有确定性，在这几个区域内就不需要过多考虑回收的问题，因为方法结束或者线程结束时，内存自然就跟着回收了。</span><br><span class="line"></span><br><span class="line">而Java堆和方法区则不一样，一个接口中的多个实现类需要的内存可能不一样，一个方法中的多个分支需要的内存也可能不一样，我们只有在程序处于运行期间时才能知道会创建哪些对象，这部分内存的分配和回收都是动态的，垃圾收集器所关注的是这部分内存。</span><br></pre></td></tr></table></figure>




<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在堆中存放着Java世界中几乎所有的对象实例，垃圾收集器在对堆进行回收前，第一件事情就是确定这些对象是不是不可能再被任何途径使用的对象。</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">引用计数算法：Reference Counting，没有被主流的虚拟机选用来管理内存，最主要的原因就是它很难解决对象之间相互循环引用的问题。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可达性分析算法：Reachability Analysis，主流的商用程序语言Java、C#等的实现中，都是通过可达性分析来判定对象是否存活的。基本思路就是通过一系列的称为GC Roots的对象作为起始点，从这些节点开始向下搜索，搜索所走过的路径称为引用链Receference Chain，当一个对象到GC Roots没有任何引用链相连的时候，图论用语就是从GC Roots到这个对象不可达的时候，则证明此对象是不可用的。</span><br></pre></td></tr></table></figure>
<p>在Java语言中，可作为GC Roots的对象包括：</p>
<table>
<thead>
<tr>
<th>GC Roots</th>
</tr>
</thead>
<tbody><tr>
<td>1、虚拟机栈/栈帧中的本地变量表中引用的对象。</td>
</tr>
<tr>
<td>2、方法区中类静态属性引用的对象。</td>
</tr>
<tr>
<td>3、方法区中常量引用的对象。</td>
</tr>
<tr>
<td>4、本地方法栈中JNI/Native方法引用的对象。</td>
</tr>
</tbody></table>
<p>引用：</p>
<table>
<thead>
<tr>
<th>引用类型</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>强引用 new</td>
<td>程序代码中普遍存在的，类似new的引用，只要强引用存在，垃圾收集器永远不会回收掉被引用的对象。</td>
</tr>
<tr>
<td>软引用 SoftReference</td>
<td>描述有用但非必需的对象，在系统将要发生内存溢出异常之前，将会把软引用对象列进回收范围之中进行第二次回收。如果这次回收还没有足够内存，才会抛出内存溢出异常。</td>
</tr>
<tr>
<td>弱引用 WeakReference</td>
<td>描述非必需对象，被若引用关联的对象只能生存到下一个垃圾收集发生之前。当垃圾收集发生时，无论当前内存是否足够，都会回收掉只被弱引用关联的对象。</td>
</tr>
<tr>
<td>虚引用 PhantomReference</td>
<td>一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用来取得一个对象实例。为一个对象设置虚引用关联的唯一目的，就是能在这个对象被收集器回收的时候收到一个系统通知。</td>
</tr>
</tbody></table>
<h1 id="finalize-方法"><a href="#finalize-方法" class="headerlink" title="finalize()方法"></a>finalize()方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">如果对象在进行可达性分析后发现没有与GC Roots相连接的引用链，那它将会被第一次标记并且进行第一次筛选，筛选的条件是此对象是否有必要执行finalize()方法。</span><br><span class="line"></span><br><span class="line">当对象没有覆盖finalize()方法，或者finalize()方法已经被虚拟机调用过，则表示没有必要执行。</span><br><span class="line"></span><br><span class="line">如果这个对象被判定为有必要执行finalize()方法，那么这个对象将会放置在一个叫做F-Queue的队列之中，并在稍后由一个由虚拟机自动建立的、低优先级的Finalizer线程去执行finalize()方法，并且任何一个对象的finalize()方法只能被系统自动调用一次。 </span><br><span class="line"></span><br><span class="line">虚拟机会触发finalize()方法，但并不承诺会等待finalize()方法运行结束，原因是如果一个对象在finalize()方法中执行缓慢或者发生了死循环，将很有可能会导致F-Queue队列中其他对象永远处于等待状态，甚至导致整个内存回收系统崩溃。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">执行完finalize()方法之后，GC将对F-Queue中的对象进行第二次小规模标记，如果这时候对象还没有逃脱，那基本上对象就真的被回收了。</span><br><span class="line"></span><br><span class="line">如果对象要在finalize()方法中逃脱，则要重新与引用链中的任何一个对象建立联系，例如将自己this赋值给某个类变量或者对象的成员变量。</span><br><span class="line"></span><br><span class="line">finalize()方法的运行代价高昂，不确定性大，无法保证各个对象的调用顺序，finalize()方法能做的工作，使用try-finally或者其他方式都可以做得更好、更及时，所以不建议使用finalize()方法。</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/15/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/15/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">ThreadLocal源码解析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-15 09:39:16 / Modified: 23:22:27" itemprop="dateCreated datePublished" datetime="2020-01-15T09:39:16+08:00">2020-01-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ThreadLocal是什么？"><a href="#ThreadLocal是什么？" class="headerlink" title="ThreadLocal是什么？"></a>ThreadLocal是什么？</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocal是用来维护线程中的变量不被其他线程干扰而出现的一个结构，内部包含一个ThreadLocalMap类，该类为Thread类的一个局部变量，该Map存储的key为ThreadLocal对象自身，value为我们要存储的对象，这样一来，在不同线程中，持有的其实都是当前线程的变量副本，与其他线程完全隔离，以此来保证线程执行过程中不受其他线程的影响。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个线程Thread对应一个ThreadLocal.ThreadLocalMap，一个线程Thread也就是一个ThreadLocalMap可以对应多个相同或不同具体类型的ThreadLocal&lt;Loop&gt;或ThreadLocal&lt;String&gt;或ThreadLocal&lt;Integer&gt;等。</span><br></pre></td></tr></table></figure>
<h1 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h1><p>一个线程对应一个ThreadLocal.ThreadLocalMap：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* ThreadLocal values pertaining to this thread. This map is maintained</span><br><span class="line"> * by the ThreadLocal class. </span><br><span class="line"> * 与此线程相关的ThreadLocal值。这个映射由ThreadLocal类维护。</span><br><span class="line"> */</span><br><span class="line">ThreadLocal.ThreadLocalMap threadLocals = null;</span><br></pre></td></tr></table></figure>
<h1 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * This class provides thread-local variables.  These variables differ from</span><br><span class="line"> * their normal counterparts in that each thread that accesses one (via its</span><br><span class="line"> * &#123;@code get&#125; or &#123;@code set&#125; method) has its own, independently initialized</span><br><span class="line"> * copy of the variable.  &#123;@code ThreadLocal&#125; instances are typically private</span><br><span class="line"> * static fields in classes that wish to associate state with a thread (e.g.,</span><br><span class="line"> * a user ID or Transaction ID).</span><br><span class="line"> * </span><br><span class="line"> * 该类提供线程局部变量。</span><br><span class="line"> * 这些变量与普通的对应变量不同，因为每个访问一个变量的线程(通过它的&#123;@code get&#125;或&#123;@code set&#125;方法)都有自己独立初始化的变量副本。</span><br><span class="line"> * &#123;@code ThreadLocal&#125;实例通常是希望将状态与线程(例如，用户ID或事务ID)关联的类中的私有静态字段。</span><br><span class="line"> * </span><br><span class="line"> * Each thread holds an implicit reference to its copy of a thread-local</span><br><span class="line"> * variable as long as the thread is alive and the &#123;@code ThreadLocal&#125;</span><br><span class="line"> * instance is accessible; after a thread goes away, all of its copies of</span><br><span class="line"> * thread-local instances are subject to garbage collection (unless other</span><br><span class="line"> * references to these copies exist).</span><br><span class="line"> * </span><br><span class="line"> * 只要线程是活动的且&#123;@code ThreadLocal&#125;实例是可访问的，每个线程都持有对其线程局部变量副本的隐式引用;</span><br><span class="line"> * 在一个线程消失后，它的所有线程本地实例副本都要进行垃圾收集(除非存在对这些副本的其他引用)。</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<h2 id="ThreadLocal-Get"><a href="#ThreadLocal-Get" class="headerlink" title="ThreadLocal.Get"></a>ThreadLocal.Get</h2><p>通过具体类型的ThreadLocal<Loop>获取当前线程的本地变量Loop：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Returns the value in the current thread&apos;s copy of this</span><br><span class="line"> * thread-local variable.  If the variable has no value for the</span><br><span class="line"> * current thread, it is first initialized to the value returned</span><br><span class="line"> * by an invocation of the &#123;@link #initialValue&#125; method.</span><br><span class="line"> * </span><br><span class="line"> * 返回当前线程的线程局部变量副本中的值。</span><br><span class="line"> * 如果变量没有当前线程的值，则首先将其初始化为调用initialValue方法返回的值。</span><br><span class="line"> * @return the current thread&apos;s value of this thread-local</span><br><span class="line"> * 			当前线程的线程本地值</span><br><span class="line"> */</span><br><span class="line">public T get() &#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    if (map != null) &#123;</span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(this);</span><br><span class="line">        if (e != null) &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            T result = (T)e.value;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return setInitialValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据线程获取线程对应的ThreadLocal.ThreadLocalMap：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Get the map associated with a ThreadLocal. Overridden in</span><br><span class="line"> * InheritableThreadLocal.</span><br><span class="line"> * 获取与ThreadLocal关联的映射。InheritableThreadLocal覆盖。</span><br><span class="line"> * @param  t the current thread</span><br><span class="line"> * 当前线程</span><br><span class="line"> * @return the map</span><br><span class="line"> * 映射</span><br><span class="line"> */</span><br><span class="line">ThreadLocalMap getMap(Thread t) &#123;</span><br><span class="line">    return t.threadLocals;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果无法获取到当前线程的本地变量，则设置初始值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Variant of set() to establish initialValue. Used instead</span><br><span class="line"> * of set() in case user has overridden the set() method.</span><br><span class="line"> * set()的变体以建立initialValue。如果用户覆盖了set()方法，则使用此方法而不是set()。</span><br><span class="line"> * @return the initial value</span><br><span class="line"> * 初始值</span><br><span class="line"> */</span><br><span class="line">private T setInitialValue() &#123;</span><br><span class="line">    T value = initialValue();</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    if (map != null)</span><br><span class="line">        map.set(this, value);</span><br><span class="line">    else</span><br><span class="line">        createMap(t, value);</span><br><span class="line">    return value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果无法获取到当前线程的ThreadLocal.ThreadLocalMap，为线程创建ThreadLocal.ThreadLocalMap：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Create the map associated with a ThreadLocal. Overridden in</span><br><span class="line"> * InheritableThreadLocal.</span><br><span class="line"> * 创建与ThreadLocal关联的映射。InheritableThreadLocal覆盖。</span><br><span class="line"> * @param t the current thread</span><br><span class="line"> * 当前线程</span><br><span class="line"> * @param firstValue value for the initial entry of the map</span><br><span class="line"> * 映射的初始项的值</span><br><span class="line"> */</span><br><span class="line">void createMap(Thread t, T firstValue) &#123;</span><br><span class="line">    t.threadLocals = new ThreadLocalMap(this, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ThreadLocal-Set"><a href="#ThreadLocal-Set" class="headerlink" title="ThreadLocal.Set"></a>ThreadLocal.Set</h2><p>通过获取具体类型ThreadLocal<Loop>设置线程本地变量Loop：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Sets the current thread&apos;s copy of this thread-local variable</span><br><span class="line"> * to the specified value.  Most subclasses will have no need to</span><br><span class="line"> * override this method, relying solely on the &#123;@link #initialValue&#125;</span><br><span class="line"> * method to set the values of thread-locals.</span><br><span class="line"> * </span><br><span class="line"> * 将此线程局部变量的当前线程副本设置为指定的值。</span><br><span class="line"> * 大多数子类将不需要重写这个方法，仅仅依靠initialValue方法来设置线程局部变量的值。</span><br><span class="line"> * @param value the value to be stored in the current thread&apos;s copy of</span><br><span class="line"> *        this thread-local.</span><br><span class="line"> *        要存储在当前线程的线程本地副本中的值。</span><br><span class="line"> */</span><br><span class="line">public void set(T value) &#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    if (map != null)</span><br><span class="line">        map.set(this, value);</span><br><span class="line">    else</span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ThreadLocal-ThreadLocalMap"><a href="#ThreadLocal-ThreadLocalMap" class="headerlink" title="ThreadLocal.ThreadLocalMap"></a>ThreadLocal.ThreadLocalMap</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ThreadLocalMap is a customized hash map suitable only for</span><br><span class="line"> * maintaining thread local values. No operations are exported</span><br><span class="line"> * outside of the ThreadLocal class. The class is package private to</span><br><span class="line"> * allow declaration of fields in class Thread.  To help deal with</span><br><span class="line"> * very large and long-lived usages, the hash table entries use</span><br><span class="line"> * WeakReferences for keys. However, since reference queues are not</span><br><span class="line"> * used, stale entries are guaranteed to be removed only when</span><br><span class="line"> * the table starts running out of space.</span><br><span class="line"> * </span><br><span class="line"> * ThreadLocalMap是一个定制的散列映射，只适用于维护线程本地值。</span><br><span class="line"> * 没有任何操作被导出到ThreadLocal类之外。类是包私有的，允许在类线程中声明字段。</span><br><span class="line"> * 为了帮助处理非常大且长期存在的用法，哈希表条目对键使用WeakReference。</span><br><span class="line"> * 但是，由于没有使用引用队列，所以只有在表空间不足时才会删除陈旧的条目。</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<h2 id="ThreadLocal-ThreadLocalMap-Entry"><a href="#ThreadLocal-ThreadLocalMap-Entry" class="headerlink" title="ThreadLocal.ThreadLocalMap.Entry"></a>ThreadLocal.ThreadLocalMap.Entry</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The entries in this hash map extend WeakReference, using</span><br><span class="line"> * its main ref field as the key (which is always a</span><br><span class="line"> * ThreadLocal object).  Note that null keys (i.e. entry.get()</span><br><span class="line"> * == null) mean that the key is no longer referenced, so the</span><br><span class="line"> * entry can be expunged from table.  Such entries are referred to</span><br><span class="line"> * as &quot;stale entries&quot; in the code that follows.</span><br><span class="line"> * </span><br><span class="line"> * 这个散列映射中的条目扩展了WeakReference，使用它的主ref字段作为键(它始终是一个ThreadLocal对象)。</span><br><span class="line"> * 注意，null键(即entry.get() == null)表示不再引用该键，因此可以从表中删除该条目。这样的条目在下面的代码中称为“陈旧的条目”。</span><br><span class="line"> */</span><br><span class="line">static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">    /** The value associated with this ThreadLocal. */</span><br><span class="line">    Object value;</span><br><span class="line"></span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">        super(k);</span><br><span class="line">        value = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ThreadLocalMap的Entry是继承WeakReference，和HashMap很大的区别是，Entry中没有next字段，所以就不存在链表的情况。</p>
<h2 id="没有链表结构，那发生hash冲突了怎么办？"><a href="#没有链表结构，那发生hash冲突了怎么办？" class="headerlink" title="没有链表结构，那发生hash冲突了怎么办？"></a>没有链表结构，那发生hash冲突了怎么办？</h2><p>每个ThreadLocal对象都有一个hash值threadLocalHashCode，每初始化一个ThreadLocal对象，hash值就增加一个固定的大小0x61c88647。</p>
<p>在插入过程中，根据ThreadLocal对象的hash值，定位到table中的位置i，过程如下： 1、如果当前位置是空的，那么正好，就初始化一个Entry对象放在位置i上； 2、不巧，位置i已经有Entry对象了，如果这个Entry对象的key正好是即将设置的key，那么重新设置Entry中的value； 3、很不巧，位置i的Entry对象，和即将设置的key没关系，那么只能找下一个空位置；<br>这样的话，在get的时候，也会根据ThreadLocal对象的hash值，定位到table中的位置，然后判断该位置Entry对象中的key是否和get的key一致，如果不一致，就判断下一个位置<br>可以发现，set和get如果冲突严重的话，效率很低，因为ThreadLoalMap是Thread的一个属性，所以即使在自己的代码中控制了设置的元素个数，但还是不能控制其它代码的行为。</p>
<h2 id="ThreadLocal可能导致内存泄漏，为什么？"><a href="#ThreadLocal可能导致内存泄漏，为什么？" class="headerlink" title="ThreadLocal可能导致内存泄漏，为什么？"></a>ThreadLocal可能导致内存泄漏，为什么？</h2><p>当使用ThreadLocal保存一个value时，会在ThreadLocalMap中的数组插入一个Entry对象，按理说key-value都应该以强引用保存在Entry对象中，但在ThreadLocalMap的实现中，key被保存到了WeakReference对象中。<br>这就导致了一个问题，ThreadLocal在没有外部强引用时，发生GC时会被回收，如果创建ThreadLocal的线程一直持续运行，那么这个Entry对象中的value就有可能一直得不到回收，发生内存泄露。</p>
<h2 id="如何避免内存泄露？"><a href="#如何避免内存泄露？" class="headerlink" title="如何避免内存泄露？"></a>如何避免内存泄露？</h2><p>在调用ThreadLocal的get()、set()可能会清除ThreadLocalMap中key为null的Entry对象，这样对应的value就没有GC Roots可达了，下次GC的时候就可以被回收，当然如果调用remove方法，肯定会删除对应的Entry对象。<br>如果使用ThreadLocal的set方法之后，没有显示的调用remove方法，就有可能发生内存泄露，所以养成良好的编程习惯十分重要，使用完ThreadLocal之后，记得调用remove方法。</p>
<p>ThreadLocal的原理：每个Thread内部维护着一个ThreadLocalMap，它是一个Map。这个映射表的Key是一个弱引用，其实就是ThreadLocal本身，Value是真正存的线程变量Object。<br>也就是说ThreadLocal本身并不真正存储线程的变量值，它只是一个工具，用来维护Thread内部的Map，帮助存和取。注意上图的虚线，它代表一个弱引用类型，而弱引用的生命周期只能存活到下次GC前。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Removes the current thread&apos;s value for this thread-local</span><br><span class="line"> * variable.  If this thread-local variable is subsequently</span><br><span class="line"> * &#123;@linkplain #get read&#125; by the current thread, its value will be</span><br><span class="line"> * reinitialized by invoking its &#123;@link #initialValue&#125; method,</span><br><span class="line"> * unless its value is &#123;@linkplain #set set&#125; by the current thread</span><br><span class="line"> * in the interim.  This may result in multiple invocations of the</span><br><span class="line"> * &#123;@code initialValue&#125; method in the current thread.</span><br><span class="line"> * 删除此线程局部变量的当前线程值。</span><br><span class="line"> * 如果这个线程局部变量随后是当前线程的get，那么它的值将通过调用它的initialValue方法来重新初始化，除非它的值是当前线程在过渡期间的set。这可能导致在当前线程中多次调用initialValue方法。</span><br><span class="line"> * @since 1.5</span><br><span class="line"> */</span><br><span class="line"> public void remove() &#123;</span><br><span class="line">     ThreadLocalMap m = getMap(Thread.currentThread());</span><br><span class="line">     if (m != null)</span><br><span class="line">         m.remove(this);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/14/%E5%BC%95%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/14/%E5%BC%95%E7%94%A8/" class="post-title-link" itemprop="url">引用</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-14 17:22:08 / Modified: 17:22:23" itemprop="dateCreated datePublished" datetime="2020-01-14T17:22:08+08:00">2020-01-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Abstract base class for reference objects.  This class defines the operations common to all reference objects.  Because reference objects are implemented in close cooperation with the garbage collector, this class may not be subclassed directly.</span><br><span class="line"></span><br><span class="line">引用对象的抽象基类。这个类定义所有引用对象共有的操作。因为引用对象是在与垃圾收集器密切合作下实现的，所以这个类可能不会被直接子类化。</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/14/%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/14/%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/" class="post-title-link" itemprop="url">虚拟机中对象的创建过程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-14 17:05:56 / Modified: 17:07:17" itemprop="dateCreated datePublished" datetime="2020-01-14T17:05:56+08:00">2020-01-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id=""><a href="#" class="headerlink" title=""></a></h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/14/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA-JVM%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-%E7%AC%AC2%E7%89%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/14/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA-JVM%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-%E7%AC%AC2%E7%89%88/" class="post-title-link" itemprop="url">深入理解Java虚拟机-JVM高级特性与最佳实践-第2版</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-14 12:38:48 / Modified: 16:56:30" itemprop="dateCreated datePublished" datetime="2020-01-14T12:38:48+08:00">2020-01-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="自动内存管理机制"><a href="#自动内存管理机制" class="headerlink" title="自动内存管理机制"></a>自动内存管理机制</h1><h1 id="Java内存区域与内存溢出异常"><a href="#Java内存区域与内存溢出异常" class="headerlink" title="Java内存区域与内存溢出异常"></a>Java内存区域与内存溢出异常</h1><p>Java虚拟机在执行Java程序的过程中，会把它所管理的内存划分为若干个不同的数据区域。</p>
<p>Java虚拟机运行时数据区</p>
<table>
<thead>
<tr>
<th>数据区</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>程序计数器 Program Counter Register</td>
<td>当前线程所执行的字节码的行号指示器。线程私有。</td>
</tr>
<tr>
<td>Java虚拟机栈 Java Virtual Machine Stacks</td>
<td>描述了Java方法执行的内存模型。线程私有。</td>
</tr>
<tr>
<td>本地方法栈Native Method Stack</td>
<td>本地方法栈为虚拟机使用到的Native方法服务，与虚拟机栈为虚拟机执行Java方法服务的作用类似。</td>
</tr>
<tr>
<td>Java堆 Java Heap</td>
<td>Java堆是被所有线程共享的一块内存区域，在虚拟机启动时创建。次内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配内存。</td>
</tr>
<tr>
<td>方法区 Method Area</td>
<td>方法区是各个线程共享的内存区域，用于存储已经被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。</td>
</tr>
</tbody></table>
<h3 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h3><p>在虚拟机的概念模型里，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖程序计数器来完成。<br>由于Java虚拟机的多线程是通过线程轮流切换并分配处理器执行时间的方式来实现的，在任何一个确定的时刻，一个处理器/内核都只会执行一条线程中的指令。因此，为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，各条线程之间计数器互不影响，独立存储，这类内存区域是线程私有的内存。<br>如果线程正在执行的是一个Java方法，则计数器记录的是正在执行的虚拟机字节码指令的地址；如果线程正在执行的是一个Native方法，则计数器值为空（Undifined）。此内存区域是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域。</p>
<h3 id="Java虚拟机栈"><a href="#Java虚拟机栈" class="headerlink" title="Java虚拟机栈"></a>Java虚拟机栈</h3><p>Java虚拟机栈的生命周期与线程相同，虚拟机栈描述了Java方法执行的内存模型，每个方法在执行的同时都会创建一个栈帧（Stack Frame）用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机中入栈到出栈的过程。</p>
<p>局部变量表存放了编译期可知的各种基础数据类型、对象引用和returnAddreass类型。其中64位的long和double类型的数据会占用2个局部变量空间(Slot)，其余的数据类型只占用1个。<br>局部变量表所需的内存空间在编译期间完成分配，当进入一个方法时，这个方法需要在帧中分配多大的局部变量空间是完全确定的，在方法运行期间不会改变局部变量表的大小。</p>
<p>在Java虚拟机规范中，对Java虚拟机栈规定了两个异常状况：如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常；如果虚拟机栈可以动态扩展，如果扩展时候无法申请到足够的内存，就会抛出OutOfMemoryError异常。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>基础数据类型</td>
<td>boolean、byte、char、short、int、float、long、double</td>
</tr>
<tr>
<td>对象引用</td>
<td>reference类型，不等同于对象本身，可能是一个指向对象起始地址的引用指针，也可能是指向一个代表对象的句柄或其他与此对象相关的位置。</td>
</tr>
<tr>
<td>returnAddress类型</td>
<td>指向了一条字节码指令的地址。</td>
</tr>
</tbody></table>
<h3 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h3><p>本地方法栈为虚拟机使用到的Native方法服务，与虚拟机栈为虚拟机执行Java方法服务的作用类似。</p>
<h3 id="Java堆"><a href="#Java堆" class="headerlink" title="Java堆"></a>Java堆</h3><p>Java堆是垃圾收集器管理的主要区域，所以也叫GC堆Garbage Collected Heap。<br>从内存回收的角度看，由于现在收集器基本都采用分代收集算法，所以Java堆可以细分为新生代和老年代，或者Eden空间、From Survivor空间、To Survivor空间。<br>从内存分配的角度看，Java堆可以划分出多个线程私有的分配缓冲区TLAB Thread Local Allocation Buffer。<br>如果堆中没有内存完成实例分配，并且堆也无法再扩展的时候，将会抛出OutOfMemoryError异常。<br>不需要连续的内存，可以选择固定大小或者可扩展。</p>
<h3 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h3><p>不需要连续的内存，可以选择固定大小或者可扩展，可以选择不实现垃圾收集。<br>当方法区无法满足内存分配需求的时候，将抛出OutOfMemoryError异常。</p>
<h3 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h3><p>Runtime Constant Pool是方法区的一部分。用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池中存放。<br>当常量池无法再申请到内存时，会抛出OutOfMemoryError异常。</p>
<h3 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a>直接内存</h3><p>Direct Memory并不是虚拟机运行时数据区的一部分，也不是Java虚拟机规范中定义的内存区域，但是这部分内存也被频繁地使用，而且也可能导致OutOfMemoryError异常出现。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/14/Java%E5%BC%B1%E5%BC%95%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/14/Java%E5%BC%B1%E5%BC%95%E7%94%A8/" class="post-title-link" itemprop="url">Java弱引用</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-14 11:27:14 / Modified: 14:05:14" itemprop="dateCreated datePublished" datetime="2020-01-14T11:27:14+08:00">2020-01-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">强引用（Strong Reference）：通常我们通过new来创建一个新对象时返回的引用就是一个强引用，若一个对象通过一系列强引用可到达，它就是强可达的(strongly reachable)，那么它就不被回收。</span><br><span class="line"></span><br><span class="line">弱引用（Weak Reference）：弱引用的对象拥有更短暂的生命周期。在垃圾回收器线程扫描它所管辖的内存区域的过程中，一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。</span><br><span class="line"></span><br><span class="line">软引用（Soft Reference）：软引用和弱引用的区别在于，若一个对象是弱引用可达，无论当前内存是否充足它都会被回收，而软引用可达的对象在内存不充足时才会被回收，因此软引用要比弱引用强一些。</span><br><span class="line"></span><br><span class="line">虚引用（Phantom Reference）：虚引用是Java中最弱的引用，那么它弱到什么程度呢？它是如此脆弱以至于我们通过虚引用甚至无法获取到被引用的对象，虚引用存在的唯一作用就是当它指向的对象被回收后，虚引用本身会被加入到引用队列中，用作记录它指向的对象已被回收。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Weak reference objects, which do not prevent their referents from being made finalizable, finalized, and then reclaimed.  Weak references are most often used to implement canonicalizing mappings.</span><br><span class="line"></span><br><span class="line">Suppose that the garbage collector determines at a certain point in time that an object is weakly reachable.  At that time it will atomically clear all weak references to that object and all weak references to any other weakly-reachable objects from which that object is reachable through a chain of strong and soft references.  At the same time it will declare all of the formerly weakly-reachable objects to be finalizable.  At the same time or at some later time it will enqueue those newly-cleared weak references that are registered with reference queues.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">弱引用对象，这并不会阻止它们的被引用对象变得可终结、最终确定，然后被回收。弱引用通常用于实现规范化映射。</span><br><span class="line"></span><br><span class="line">假设垃圾收集器在某一时间点确定对象是弱可及的。此时，它将原子性地清除对该对象的所有弱引用，以及对任何其他弱可及对象的所有弱引用，从这些弱可及对象可以通过强和软引用链访问。同时，它将声明所有以前弱可及的对象都是可终结的。与此同时，或者在以后的某个时候，它将对那些新清除的弱引用进行排队，这些弱引用是用引用队列注册的。</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class WeakReference&lt;T&gt; extends Reference&lt;T&gt; &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Creates a new weak reference that refers to the given object.  The new</span><br><span class="line">     * reference is not registered with any queue.</span><br><span class="line">     * 创建引用给定对象的新弱引用。新引用未在任何队列中注册。</span><br><span class="line">     * @param referent object the new weak reference will refer to</span><br><span class="line">     * 新的弱引用将引用的对象</span><br><span class="line">     */</span><br><span class="line">    public WeakReference(T referent) &#123;</span><br><span class="line">        super(referent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Creates a new weak reference that refers to the given object and is</span><br><span class="line">     * registered with the given queue.</span><br><span class="line">     * 创建一个新的弱引用，该引用引用给定的对象，并在给定的队列中注册。</span><br><span class="line">     * @param referent object the new weak reference will refer to</span><br><span class="line">     * 新的弱引用将引用的对象</span><br><span class="line">     * @param q the queue with which the reference is to be registered,</span><br><span class="line">     *          or null if registration is not required</span><br><span class="line">     * 要注册引用的队列，如果不需要注册则为空</span><br><span class="line">     */</span><br><span class="line">    public WeakReference(T referent, ReferenceQueue&lt;? super T&gt; q) &#123;</span><br><span class="line">        super(referent, q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/14/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90IntentService/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/14/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90IntentService/" class="post-title-link" itemprop="url">源码解析IntentService</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-14 10:05:12 / Modified: 14:05:16" itemprop="dateCreated datePublished" datetime="2020-01-14T10:05:12+08:00">2020-01-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/14/Android%E9%9D%A2%E8%AF%95%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/14/Android%E9%9D%A2%E8%AF%95%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">Android面试知识总结</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-14 09:39:15 / Modified: 14:05:19" itemprop="dateCreated datePublished" datetime="2020-01-14T09:39:15+08:00">2020-01-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1、简述Handler消息机制"><a href="#1、简述Handler消息机制" class="headerlink" title="1、简述Handler消息机制"></a>1、简述Handler消息机制</h2><p>说一下Handler发送和接收消息的实现，尤其是Message的消息载体的工作流程。</p>
<h2 id="2、Service和IntentService有什么区别？"><a href="#2、Service和IntentService有什么区别？" class="headerlink" title="2、Service和IntentService有什么区别？"></a>2、Service和IntentService有什么区别？</h2><h2 id="3、Service和Activity之间的通讯怎么实现？"><a href="#3、Service和Activity之间的通讯怎么实现？" class="headerlink" title="3、Service和Activity之间的通讯怎么实现？"></a>3、Service和Activity之间的通讯怎么实现？</h2><p>比如Service里面某个后台任务结束，怎么通知当前活动Activity，并且把结果传递出去？</p>
<h2 id="4、Context-的sendBroadcast和LocalBroadcastManager-的sendBroadcast有什么区别？"><a href="#4、Context-的sendBroadcast和LocalBroadcastManager-的sendBroadcast有什么区别？" class="headerlink" title="4、Context 的sendBroadcast和LocalBroadcastManager 的sendBroadcast有什么区别？"></a>4、Context 的sendBroadcast和LocalBroadcastManager 的sendBroadcast有什么区别？</h2><p>从MVP、MVVM等流行结构框架问到多线程同步，然后再问点击事件分发，到自定义View，再聊动画效果实现，基础的ArrayList、HashMap底层实现，final static关键字用法，进阶的设计模式里面单例模式和观察者模式的实现，java类加载、内存分配，没用过设计模式，没用过分层框架设计。</p>
<h2 id="ImageLoader的本地缓存机制是怎么实现的？"><a href="#ImageLoader的本地缓存机制是怎么实现的？" class="headerlink" title="ImageLoader的本地缓存机制是怎么实现的？"></a>ImageLoader的本地缓存机制是怎么实现的？</h2><h2 id="Activity的onStop-函数是否一定会被调用？"><a href="#Activity的onStop-函数是否一定会被调用？" class="headerlink" title="Activity的onStop()函数是否一定会被调用？"></a>Activity的onStop()函数是否一定会被调用？</h2><h2 id="Intent传递数据的限制，数据类型？数据大小？"><a href="#Intent传递数据的限制，数据类型？数据大小？" class="headerlink" title="Intent传递数据的限制，数据类型？数据大小？"></a>Intent传递数据的限制，数据类型？数据大小？</h2><h2 id="服务器正常，App访问服务器失败的原因都有哪些？"><a href="#服务器正常，App访问服务器失败的原因都有哪些？" class="headerlink" title="服务器正常，App访问服务器失败的原因都有哪些？"></a>服务器正常，App访问服务器失败的原因都有哪些？</h2><h2 id="有没有关注Android动态？简单说一下新版本的特性？"><a href="#有没有关注Android动态？简单说一下新版本的特性？" class="headerlink" title="有没有关注Android动态？简单说一下新版本的特性？"></a>有没有关注Android动态？简单说一下新版本的特性？</h2><h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2><ol>
<li>UI 线程是干什么用的？然后顺着这条线开始问 Activity 的启动过程以及启动失败的异常处理。</li>
<li>事件分发流程。然后沿着这条主线问View实现原理，以及 View和主线程的联系，事件冲突的处理。</li>
<li>做过什么酷炫的动画？沿着这条线问下动画的基础以及动画和View ，主线程联系。</li>
<li>用过什么网络框架，各大网络框架的优缺点。顺便考察 HTTP TCP/IP 的基础。如果用过Okhttp，聊聊源码，以及问什么Okhttp比大多数网络库好。</li>
<li>问问 新技术新理念，比如 RN，Rxjava等。</li>
<li>聊聊插件化原理和各大实现方案利弊，顺便聊聊路由问题。</li>
<li>安全，加固。</li>
</ol>
<h2 id="Android事件分发机制确实很难，最好的方式边看源码边画流程图。"><a href="#Android事件分发机制确实很难，最好的方式边看源码边画流程图。" class="headerlink" title="Android事件分发机制确实很难，最好的方式边看源码边画流程图。"></a>Android事件分发机制确实很难，最好的方式边看源码边画流程图。</h2><p>Activity生命周期和消息机制必须要熟悉、 Binder, AMS WMS 最好了解下。还有性能优化某一方面，比如内存优化，启动优化，CPU占用优化等。</p>
<p>Binder机制，Zygote，Android系统启动流程，Android源码中的设计模式，插件化原理，热更新（修复）原理，Android常用GitHub库源码（网络，图片，注入，插件化等方面）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/12/Glide%E8%A7%A3%E6%9E%90-(%E5%88%9D%E5%A7%8B%E5%8C%96)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/12/Glide%E8%A7%A3%E6%9E%90-(%E5%88%9D%E5%A7%8B%E5%8C%96)/" class="post-title-link" itemprop="url">Glide解析-(初始化)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-12 15:12:03 / Modified: 17:54:47" itemprop="dateCreated datePublished" datetime="2020-01-12T15:12:03+08:00">2020-01-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Glide获取RequestManager"><a href="#Glide获取RequestManager" class="headerlink" title="Glide获取RequestManager"></a>Glide获取RequestManager</h1><table>
<thead>
<tr>
<th>方法</th>
</tr>
</thead>
<tbody><tr>
<td>Glide.with(Context)</td>
</tr>
<tr>
<td>Glide.with(Activity)</td>
</tr>
<tr>
<td>Glide.with(FragmentActivity)</td>
</tr>
<tr>
<td>Glide.with(androidx.fragment.app.Fragment)</td>
</tr>
<tr>
<td>Glide.with(android.app.Fragment)</td>
</tr>
<tr>
<td>Glide.with(View)</td>
</tr>
<tr>
<td><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@NonNull</span><br><span class="line">public static RequestManager with(@NonNull Context context) &#123;</span><br><span class="line">  return getRetriever(context).get(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></td>
</tr>
<tr>
<td>## 1、Glide获取RequestManagerRetriever</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@NonNull</span><br><span class="line">private static RequestManagerRetriever getRetriever(@Nullable Context context) &#123;</span><br><span class="line">  return Glide.get(context).getRequestManagerRetriever();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-1、Glide获取单例"><a href="#1-1、Glide获取单例" class="headerlink" title="1.1、Glide获取单例"></a>1.1、Glide获取单例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@NonNull</span><br><span class="line">public static Glide get(@NonNull Context context) &#123;</span><br><span class="line">  if (glide == null) &#123;</span><br><span class="line">    GeneratedAppGlideModule annotationGeneratedModule =</span><br><span class="line">        getAnnotationGeneratedGlideModules(context.getApplicationContext());</span><br><span class="line">    synchronized (Glide.class) &#123;</span><br><span class="line">      if (glide == null) &#123;</span><br><span class="line">      //检查并初始化Glide</span><br><span class="line">        checkAndInitializeGlide(context, annotationGeneratedModule);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return glide;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-1、Glide获取GeneratedAppGlideModule"><a href="#1-1-1、Glide获取GeneratedAppGlideModule" class="headerlink" title="1.1.1、Glide获取GeneratedAppGlideModule"></a>1.1.1、Glide获取GeneratedAppGlideModule</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;TryWithIdenticalCatches&quot;, &quot;PMD.UnusedFormalParameter&quot;&#125;)</span><br><span class="line">private static GeneratedAppGlideModule getAnnotationGeneratedGlideModules(Context context) &#123;</span><br><span class="line">//获取通过注解动态生成的的AppGlideModule的实现类</span><br><span class="line">Class&lt;GeneratedAppGlideModule&gt; clazz =</span><br><span class="line">        (Class&lt;GeneratedAppGlideModule&gt;)</span><br><span class="line">            Class.forName(&quot;com.bumptech.glide.GeneratedAppGlideModuleImpl&quot;);</span><br><span class="line">GeneratedAppGlideModule result = clazz.getDeclaredConstructor(Context.class).newInstance(context.getApplicationContext());</span><br><span class="line">return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-2、初始化Glide"><a href="#1-1-2、初始化Glide" class="headerlink" title="1.1.2、初始化Glide"></a>1.1.2、初始化Glide</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@GuardedBy(&quot;Glide.class&quot;)</span><br><span class="line">private static void initializeGlide(</span><br><span class="line">    @NonNull Context context, @Nullable GeneratedAppGlideModule generatedAppGlideModule) &#123;</span><br><span class="line">  initializeGlide(context, new GlideBuilder(), generatedAppGlideModule);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">@GuardedBy(&quot;Glide.class&quot;)</span><br><span class="line">@SuppressWarnings(&quot;deprecation&quot;)</span><br><span class="line">private static void initializeGlide(</span><br><span class="line">    @NonNull Context context,</span><br><span class="line">    @NonNull GlideBuilder builder,</span><br><span class="line">    @Nullable GeneratedAppGlideModule annotationGeneratedModule) &#123;</span><br><span class="line">  Context applicationContext = context.getApplicationContext();</span><br><span class="line">  //从Manifest获取定义的GlideModule列表，新版本已经废弃</span><br><span class="line">  List&lt;com.bumptech.glide.module.GlideModule&gt; manifestModules = Collections.emptyList();</span><br><span class="line">  if (annotationGeneratedModule == null || annotationGeneratedModule.isManifestParsingEnabled()) &#123;</span><br><span class="line">    manifestModules = new ManifestParser(applicationContext).parse();</span><br><span class="line">  &#125;</span><br><span class="line">  //从注解动态生成的的AppGlideModule的实现类中去掉Manifest定义的GlideMoldue</span><br><span class="line">  if (annotationGeneratedModule != null</span><br><span class="line">      &amp;&amp; !annotationGeneratedModule.getExcludedModuleClasses().isEmpty()) &#123;</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; excludedModuleClasses = annotationGeneratedModule.getExcludedModuleClasses();</span><br><span class="line">    Iterator&lt;com.bumptech.glide.module.GlideModule&gt; iterator = manifestModules.iterator();</span><br><span class="line">    while (iterator.hasNext()) &#123;</span><br><span class="line">      com.bumptech.glide.module.GlideModule current = iterator.next();</span><br><span class="line">      if (!excludedModuleClasses.contains(current.getClass())) &#123;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">      iterator.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  //设置RequestManager的工厂类</span><br><span class="line">  RequestManagerRetriever.RequestManagerFactory factory =</span><br><span class="line">      annotationGeneratedModule != null</span><br><span class="line">          ? annotationGeneratedModule.getRequestManagerFactory()</span><br><span class="line">          : null;</span><br><span class="line">  builder.setRequestManagerFactory(factory);</span><br><span class="line">  //将Manifest定义的GlideModule中的配置选项设置到glideBuilder中</span><br><span class="line">  for (com.bumptech.glide.module.GlideModule module : manifestModules) &#123;</span><br><span class="line">    module.applyOptions(applicationContext, builder);</span><br><span class="line">  &#125;</span><br><span class="line">  //将注解动态生成的的AppGlideModule的实现类中的配置选项设置到glideBuilder中</span><br><span class="line">  if (annotationGeneratedModule != null) &#123;</span><br><span class="line">    annotationGeneratedModule.applyOptions(applicationContext, builder);</span><br><span class="line">  &#125;</span><br><span class="line">  //使用GlideBuilder构建生成Glide</span><br><span class="line">  Glide glide = builder.build(applicationContext);</span><br><span class="line">  for (com.bumptech.glide.module.GlideModule module : manifestModules) &#123;</span><br><span class="line">  //将Manifest定义的GlideModule中定义的Glide组件注册到Glide中</span><br><span class="line">  module.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">  //将注解动态生成的的AppGlideModule的实现类中定义的Glide组件注册到Glide中</span><br><span class="line">  if (annotationGeneratedModule != null) &#123;</span><br><span class="line">    annotationGeneratedModule.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">  &#125;</span><br><span class="line">  //glide监听Application的组件生命周期</span><br><span class="line">  applicationContext.registerComponentCallbacks(glide);</span><br><span class="line">  Glide.glide = glide;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-3、GlideBuilder-build构建Glide对象"><a href="#1-1-3、GlideBuilder-build构建Glide对象" class="headerlink" title="1.1.3、GlideBuilder.build构建Glide对象"></a>1.1.3、GlideBuilder.build构建Glide对象</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">@NonNull</span><br><span class="line">Glide build(@NonNull Context context) &#123;</span><br><span class="line">    if (sourceExecutor == null) &#123;</span><br><span class="line">      //默认不自定义网络加载线程池的情况下，使用默认的网络加载线程池</span><br><span class="line">      //创建网络加载线程池对象</span><br><span class="line">      sourceExecutor = GlideExecutor.newSourceExecutor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (diskCacheExecutor == null) &#123;</span><br><span class="line">       //默认不自定义磁盘加载线程池的情况下，使用默认的磁盘加载线程池</span><br><span class="line">      //创建磁盘加载线程池对象</span><br><span class="line">      diskCacheExecutor = GlideExecutor.newDiskCacheExecutor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (animationExecutor == null) &#123;</span><br><span class="line">      //默认不自定义动画加载线程池的情况下，使用默认的动画加载线程池</span><br><span class="line">      //创建动画加载线程池对象</span><br><span class="line">      animationExecutor = GlideExecutor.newAnimationExecutor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (memorySizeCalculator == null) &#123;</span><br><span class="line">      //创建内存大小计算器</span><br><span class="line">      memorySizeCalculator = new MemorySizeCalculator.Builder(context).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (connectivityMonitorFactory == null) &#123;</span><br><span class="line">      //创建默认的网络连接监听工厂类</span><br><span class="line">      connectivityMonitorFactory = new DefaultConnectivityMonitorFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (bitmapPool == null) &#123;</span><br><span class="line">      //获取Bitmap池的大小</span><br><span class="line">      int size = memorySizeCalculator.getBitmapPoolSize();</span><br><span class="line">      if (size &gt; 0) &#123;</span><br><span class="line">        //如果Bitmap池的大小大于0，采用LruBitmapPool</span><br><span class="line">        bitmapPool = new LruBitmapPool(size);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        //如果Bitmap池的大小于小于或等于0，采用BitmapPoolAdapter</span><br><span class="line">        bitmapPool = new BitmapPoolAdapter();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (arrayPool == null) &#123;</span><br><span class="line">      //arrayPool是对数组池，主要用于图片解析时存储临时数据用</span><br><span class="line">      //根据数组池的大小创建LruArrayPool</span><br><span class="line">      arrayPool = new LruArrayPool(memorySizeCalculator.getArrayPoolSizeInBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (memoryCache == null) &#123;</span><br><span class="line">      //创建内存缓存实现类</span><br><span class="line">      memoryCache = new LruResourceCache(memorySizeCalculator.getMemoryCacheSize());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (diskCacheFactory == null) &#123;</span><br><span class="line">      //创建磁盘缓存工厂类</span><br><span class="line">      diskCacheFactory = new InternalCacheDiskCacheFactory(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (engine == null) &#123;</span><br><span class="line">      //创建图片加载引起对象</span><br><span class="line">      engine =</span><br><span class="line">          new Engine(</span><br><span class="line">              memoryCache,</span><br><span class="line">              diskCacheFactory,</span><br><span class="line">              diskCacheExecutor,</span><br><span class="line">              sourceExecutor,</span><br><span class="line">              GlideExecutor.newUnlimitedSourceExecutor(),</span><br><span class="line">              GlideExecutor.newAnimationExecutor(),</span><br><span class="line">              isActiveResourceRetentionAllowed);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //创建RequestManagerRetriever对象</span><br><span class="line">    RequestManagerRetriever requestManagerRetriever =</span><br><span class="line">        new RequestManagerRetriever(requestManagerFactory);</span><br><span class="line"></span><br><span class="line">    //创建Glide对象</span><br><span class="line">    return new Glide(</span><br><span class="line">        context,</span><br><span class="line">        engine,</span><br><span class="line">        memoryCache,</span><br><span class="line">        bitmapPool,</span><br><span class="line">        arrayPool,</span><br><span class="line">        requestManagerRetriever,</span><br><span class="line">        connectivityMonitorFactory,</span><br><span class="line">        logLevel,</span><br><span class="line">        defaultRequestOptions.lock(),</span><br><span class="line">        defaultTransitionOptions);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-4、创建Glide对象"><a href="#1-1-4、创建Glide对象" class="headerlink" title="1.1.4、创建Glide对象"></a>1.1.4、创建Glide对象</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line">Glide(</span><br><span class="line">      @NonNull Context context,</span><br><span class="line">      @NonNull Engine engine,</span><br><span class="line">      @NonNull MemoryCache memoryCache,</span><br><span class="line">      @NonNull BitmapPool bitmapPool,</span><br><span class="line">      @NonNull ArrayPool arrayPool,</span><br><span class="line">      @NonNull RequestManagerRetriever requestManagerRetriever,</span><br><span class="line">      @NonNull ConnectivityMonitorFactory connectivityMonitorFactory,</span><br><span class="line">      int logLevel,</span><br><span class="line">      @NonNull RequestOptions defaultRequestOptions,</span><br><span class="line">      @NonNull Map&lt;Class&lt;?&gt;, TransitionOptions&lt;?, ?&gt;&gt; defaultTransitionOptions) &#123;</span><br><span class="line">    //设置图片加载引擎</span><br><span class="line">    this.engine = engine;</span><br><span class="line">    //设置bitmap池</span><br><span class="line">    this.bitmapPool = bitmapPool;</span><br><span class="line">    //设置数组池</span><br><span class="line">    this.arrayPool = arrayPool;</span><br><span class="line">    //设置内存缓存</span><br><span class="line">    this.memoryCache = memoryCache;</span><br><span class="line">    //设置requestManagerRetriever </span><br><span class="line">    this.requestManagerRetriever = requestManagerRetriever;</span><br><span class="line">    //设置网络连接监听工厂类</span><br><span class="line">    this.connectivityMonitorFactory = connectivityMonitorFactory;</span><br><span class="line">    //获取图片解码格式</span><br><span class="line">    DecodeFormat decodeFormat = defaultRequestOptions.getOptions().get(Downsampler.DECODE_FORMAT);</span><br><span class="line">    //创建Bitmap预填充对象</span><br><span class="line">    bitmapPreFiller = new BitmapPreFiller(memoryCache, bitmapPool, decodeFormat);</span><br><span class="line">    //获取资源对象</span><br><span class="line">    final Resources resources = context.getResources();</span><br><span class="line">    //创建注册对象</span><br><span class="line">    registry = new Registry();</span><br><span class="line">    // Right now we&apos;re only using this parser for HEIF images, which are only supported on OMR1+.</span><br><span class="line">    // If we need this for other file types, we should consider removing this restriction.</span><br><span class="line">    // Note that order here matters. We want to check the ExifInterface parser first for orientation</span><br><span class="line">    // and then fall back to DefaultImageHeaderParser for other fields.</span><br><span class="line">    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O_MR1) &#123;</span><br><span class="line">      //android8.1之后支持heif图片格式，注册ExifInterfaceImageHeaderParser用来解析heif图片的方向信息</span><br><span class="line">      registry.register(new ExifInterfaceImageHeaderParser());</span><br><span class="line">    &#125;</span><br><span class="line">    //注册默认DefaultImageHeaderParser用来解析图片的格式、方向等信息</span><br><span class="line">    registry.register(new DefaultImageHeaderParser());</span><br><span class="line">    //创建图片采样Downsamples，用与解析图片并根据图片的方向进行相应的旋转处理</span><br><span class="line">    Downsampler downsampler = new Downsampler(registry.getImageHeaderParsers(),</span><br><span class="line">        resources.getDisplayMetrics(), bitmapPool, arrayPool);</span><br><span class="line">    //创建gif图片解析器ByteBufferGifDecoder，用于从输入流中解析gif</span><br><span class="line">    ByteBufferGifDecoder byteBufferGifDecoder =</span><br><span class="line">        new ByteBufferGifDecoder(context, registry.getImageHeaderParsers(), bitmapPool, arrayPool);</span><br><span class="line">    //创建视频解析器VideoDecoder，用于将assetfile或parcelfile的视频文件解析成bitmap</span><br><span class="line">    ResourceDecoder&lt;ParcelFileDescriptor, Bitmap&gt; parcelFileDescriptorVideoDecoder =</span><br><span class="line">        VideoDecoder.parcel(bitmapPool);</span><br><span class="line">    //创建字节缓冲图片解析器，用于从字节缓冲中解析出bitmap</span><br><span class="line">    ByteBufferBitmapDecoder byteBufferBitmapDecoder = new ByteBufferBitmapDecoder(downsampler);</span><br><span class="line">    //创建输入流图片解析器，用于从输入流中解析出bitmap</span><br><span class="line">    StreamBitmapDecoder streamBitmapDecoder = new StreamBitmapDecoder(downsampler, arrayPool);</span><br><span class="line">    //创建Drawable图片解析器， 用于从uri中解析出drawable</span><br><span class="line">    ResourceDrawableDecoder resourceDrawableDecoder =</span><br><span class="line">        new ResourceDrawableDecoder(context);</span><br><span class="line">    //创建app资源图片加载器的工厂类，用于创建app资源图片加载器，并指明从资源图片id中加载资源图片的输入流</span><br><span class="line">    ResourceLoader.StreamFactory resourceLoaderStreamFactory =</span><br><span class="line">        new ResourceLoader.StreamFactory(resources);</span><br><span class="line">    //创建app自身资源图片加载器的工厂类，用于创建app资源图片加载器，并指明从资源图片id中加载资源图片的uri</span><br><span class="line">    ResourceLoader.UriFactory resourceLoaderUriFactory =</span><br><span class="line">        new ResourceLoader.UriFactory(resources);</span><br><span class="line">//创建app自身资源图片加载器的工厂类，用于创建app资源图片加载器，并指明从资源图片id中加载资源图片的ParcelFileDescriptor</span><br><span class="line">    ResourceLoader.FileDescriptorFactory resourceLoaderFileDescriptorFactory =</span><br><span class="line">        new ResourceLoader.FileDescriptorFactory(resources);</span><br><span class="line">//创建app自身资源图片加载器的工厂类，用于创建app资源图片加载器，并指明从资源图片id中加载资源图片的AssetFileDescriptor</span><br><span class="line">    ResourceLoader.AssetFileDescriptorFactory resourceLoaderAssetFileDescriptorFactory =</span><br><span class="line">        new ResourceLoader.AssetFileDescriptorFactory(resources);</span><br><span class="line">    //创建bitmap编码器，用于向输出流写bitmap</span><br><span class="line">    BitmapEncoder bitmapEncoder = new BitmapEncoder(arrayPool);</span><br><span class="line">    //创建bitmap转换器，用于将bitmap转换成字节流</span><br><span class="line">    BitmapBytesTranscoder bitmapBytesTranscoder = new BitmapBytesTranscoder();</span><br><span class="line">    //创建gif转换器，用于将gif转换成字节流</span><br><span class="line">    GifDrawableBytesTranscoder gifDrawableBytesTranscoder = new GifDrawableBytesTranscoder();</span><br><span class="line">    </span><br><span class="line">    ContentResolver contentResolver = context.getContentResolver();</span><br><span class="line"></span><br><span class="line">    registry</span><br><span class="line">        //注册基于字节缓冲的图片编码器，用于将字节缓冲写到文件中</span><br><span class="line">        .append(ByteBuffer.class, new ByteBufferEncoder())</span><br><span class="line">        //注册基于输入流的图片编码器，用于将输入流写到磁盘中</span><br><span class="line">        .append(InputStream.class, new StreamEncoder(arrayPool))</span><br><span class="line">        /* Bitmaps */</span><br><span class="line">        //注册将字节缓冲解码成Bitmap的图片解码器</span><br><span class="line">        .append(Registry.BUCKET_BITMAP, ByteBuffer.class, Bitmap.class, byteBufferBitmapDecoder)</span><br><span class="line">        //注册将输入流解码成Bitmap的图片解码器</span><br><span class="line">        .append(Registry.BUCKET_BITMAP, InputStream.class, Bitmap.class, streamBitmapDecoder)</span><br><span class="line">        //注册将ParcelFileDescriptor解码成Bitmap的图片解码器</span><br><span class="line">        .append(</span><br><span class="line">            Registry.BUCKET_BITMAP,</span><br><span class="line">            ParcelFileDescriptor.class,</span><br><span class="line">            Bitmap.class,</span><br><span class="line">            parcelFileDescriptorVideoDecoder)</span><br><span class="line">        //注册将AssetFileDescriptor解码成Bitmap的图片解码器</span><br><span class="line">        .append(</span><br><span class="line">            Registry.BUCKET_BITMAP,</span><br><span class="line">            AssetFileDescriptor.class,</span><br><span class="line">            Bitmap.class,</span><br><span class="line">            VideoDecoder.asset(bitmapPool))</span><br><span class="line">        //注册将Bitmap解码成Bitmap的图片解码器</span><br><span class="line">        .append(Bitmap.class, Bitmap.class, UnitModelLoader.Factory.&lt;Bitmap&gt;getInstance())</span><br><span class="line">        .append(</span><br><span class="line">            Registry.BUCKET_BITMAP, Bitmap.class, Bitmap.class, new UnitBitmapDecoder())</span><br><span class="line">        .append(Bitmap.class, bitmapEncoder)</span><br><span class="line">        /* BitmapDrawables */</span><br><span class="line">        //注册各种转换成BitmapDrawable的图片解码器</span><br><span class="line">        .append(</span><br><span class="line">            Registry.BUCKET_BITMAP_DRAWABLE,</span><br><span class="line">            ByteBuffer.class,</span><br><span class="line">            BitmapDrawable.class,</span><br><span class="line">            new BitmapDrawableDecoder&lt;&gt;(resources, byteBufferBitmapDecoder))</span><br><span class="line">        .append(</span><br><span class="line">            Registry.BUCKET_BITMAP_DRAWABLE,</span><br><span class="line">            InputStream.class,</span><br><span class="line">            BitmapDrawable.class,</span><br><span class="line">            new BitmapDrawableDecoder&lt;&gt;(resources, streamBitmapDecoder))</span><br><span class="line">        .append(</span><br><span class="line">            Registry.BUCKET_BITMAP_DRAWABLE,</span><br><span class="line">            ParcelFileDescriptor.class,</span><br><span class="line">            BitmapDrawable.class,</span><br><span class="line">            new BitmapDrawableDecoder&lt;&gt;(resources, parcelFileDescriptorVideoDecoder))</span><br><span class="line">        .append(BitmapDrawable.class, new BitmapDrawableEncoder(bitmapPool, bitmapEncoder))</span><br><span class="line">        /* GIFs */</span><br><span class="line">        //注册各种转换成gif的图片解码器</span><br><span class="line">        .append(</span><br><span class="line">            Registry.BUCKET_GIF,</span><br><span class="line">            InputStream.class,</span><br><span class="line">            GifDrawable.class,</span><br><span class="line">            new StreamGifDecoder(registry.getImageHeaderParsers(), byteBufferGifDecoder, arrayPool))</span><br><span class="line">        .append(Registry.BUCKET_GIF, ByteBuffer.class, GifDrawable.class, byteBufferGifDecoder)</span><br><span class="line">        .append(GifDrawable.class, new GifDrawableEncoder())</span><br><span class="line">        /* GIF Frames */</span><br><span class="line">        // Compilation with Gradle requires the type to be specified for UnitModelLoader here.</span><br><span class="line">        .append(</span><br><span class="line">            GifDecoder.class, GifDecoder.class, UnitModelLoader.Factory.&lt;GifDecoder&gt;getInstance())</span><br><span class="line">        .append(</span><br><span class="line">            Registry.BUCKET_BITMAP,</span><br><span class="line">            GifDecoder.class,</span><br><span class="line">            Bitmap.class,</span><br><span class="line">            new GifFrameResourceDecoder(bitmapPool))</span><br><span class="line">        /* Drawables */</span><br><span class="line">        .append(Uri.class, Drawable.class, resourceDrawableDecoder)</span><br><span class="line">        .append(</span><br><span class="line">            Uri.class, Bitmap.class, new ResourceBitmapDecoder(resourceDrawableDecoder, bitmapPool))</span><br><span class="line">        /* Files */</span><br><span class="line">        注册各种解析图片文件的图片加载器和图片解码器</span><br><span class="line">        .register(new ByteBufferRewinder.Factory())</span><br><span class="line">        .append(File.class, ByteBuffer.class, new ByteBufferFileLoader.Factory())</span><br><span class="line">        .append(File.class, InputStream.class, new FileLoader.StreamFactory())</span><br><span class="line">        .append(File.class, File.class, new FileDecoder())</span><br><span class="line">        .append(File.class, ParcelFileDescriptor.class, new FileLoader.FileDescriptorFactory())</span><br><span class="line">        // Compilation with Gradle requires the type to be specified for UnitModelLoader here.</span><br><span class="line">        //注册各种图片加载器</span><br><span class="line">        .append(File.class, File.class, UnitModelLoader.Factory.&lt;File&gt;getInstance())</span><br><span class="line">        /* Models */</span><br><span class="line">        .register(new InputStreamRewinder.Factory(arrayPool))</span><br><span class="line">        //注册将Integer转成InputStream的图片加载器工厂类</span><br><span class="line">        .append(int.class, InputStream.class, resourceLoaderStreamFactory)</span><br><span class="line">        //注册将int转成ParcelFileDescriptor的图片加载器工厂类</span><br><span class="line">        .append(</span><br><span class="line">            int.class,</span><br><span class="line">            ParcelFileDescriptor.class,</span><br><span class="line">            resourceLoaderFileDescriptorFactory)</span><br><span class="line">        //注册将Integer转成InputStream的图片加载器工厂类</span><br><span class="line">        .append(Integer.class, InputStream.class, resourceLoaderStreamFactory)</span><br><span class="line">        //注册将Integer转成ParcelFileDescriptor的图片加载器工厂类</span><br><span class="line">        .append(</span><br><span class="line">            Integer.class,</span><br><span class="line">            ParcelFileDescriptor.class,</span><br><span class="line">            resourceLoaderFileDescriptorFactory)</span><br><span class="line">        .append(Integer.class, Uri.class, resourceLoaderUriFactory)</span><br><span class="line">        //注册将int转成AssetFileDescriptor的图片加载器工厂类</span><br><span class="line">        .append(</span><br><span class="line">            int.class,</span><br><span class="line">            AssetFileDescriptor.class,</span><br><span class="line">            resourceLoaderAssetFileDescriptorFactory)</span><br><span class="line">        //注册将Integer转成AssetFileDescriptor的图片加载器工厂类</span><br><span class="line">        .append(</span><br><span class="line">            Integer.class,</span><br><span class="line">            AssetFileDescriptor.class,</span><br><span class="line">            resourceLoaderAssetFileDescriptorFactory)</span><br><span class="line">        //注册将int转成Uri的图片加载器工厂类</span><br><span class="line">        .append(int.class, Uri.class, resourceLoaderUriFactory)</span><br><span class="line">        //注册将String转成输入流的图片加载器工厂类</span><br><span class="line">        .append(String.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;String&gt;())</span><br><span class="line">        //注册将Uri转成输入流的图片加载器工厂类</span><br><span class="line">        .append(Uri.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;Uri&gt;())</span><br><span class="line">        .append(String.class, InputStream.class, new StringLoader.StreamFactory())</span><br><span class="line">        //注册将String转成ParcelFileDescriptor的图片加载器工厂类</span><br><span class="line">        .append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</span><br><span class="line">        //注册将String转成AssetFileDescriptor的图片加载器工厂类</span><br><span class="line">        .append(</span><br><span class="line">            String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</span><br><span class="line">        .append(Uri.class, InputStream.class, new HttpUriLoader.Factory())</span><br><span class="line">        //注册将Uri转成输入流的图片加载器工厂类</span><br><span class="line">        .append(Uri.class, InputStream.class, new AssetUriLoader.StreamFactory(context.getAssets()))</span><br><span class="line">        //注册将Uri转成ParcelFileDescriptor的图片加载器工厂类</span><br><span class="line">        .append(</span><br><span class="line">            Uri.class,</span><br><span class="line">            ParcelFileDescriptor.class,</span><br><span class="line">            new AssetUriLoader.FileDescriptorFactory(context.getAssets()))</span><br><span class="line">        //注册将Uri转成输入流的图片加载器工厂类</span><br><span class="line">        .append(Uri.class, InputStream.class, new MediaStoreImageThumbLoader.Factory(context))</span><br><span class="line">        //注册将Uri转成输入流的图片加载器工厂类</span><br><span class="line">        .append(Uri.class, InputStream.class, new MediaStoreVideoThumbLoader.Factory(context))</span><br><span class="line">        //注册将Uri转成输入流的图片加载器工厂类</span><br><span class="line">        .append(</span><br><span class="line">            Uri.class,</span><br><span class="line">            InputStream.class,</span><br><span class="line">            new UriLoader.StreamFactory(contentResolver))</span><br><span class="line">        //注册将Uri转成ParcelFileDescriptor的图片加载器工厂类</span><br><span class="line">        .append(</span><br><span class="line">            Uri.class,</span><br><span class="line">            ParcelFileDescriptor.class,</span><br><span class="line">             new UriLoader.FileDescriptorFactory(contentResolver))</span><br><span class="line">        //注册将Uri转成AssetFileDescriptor的图片加载器工厂类</span><br><span class="line">        .append(</span><br><span class="line">            Uri.class,</span><br><span class="line">            AssetFileDescriptor.class,</span><br><span class="line">            new UriLoader.AssetFileDescriptorFactory(contentResolver))</span><br><span class="line">        //注册将Uri转成输入流的图片加载器工厂类</span><br><span class="line">        .append(Uri.class, InputStream.class, new UrlUriLoader.StreamFactory())</span><br><span class="line">        //注册将URL转成输入流的图片加载器工厂类</span><br><span class="line">        .append(URL.class, InputStream.class, new UrlLoader.StreamFactory())</span><br><span class="line">        //注册将Uri转成文件的图片加载器工厂类</span><br><span class="line">        .append(Uri.class, File.class, new MediaStoreFileLoader.Factory(context))</span><br><span class="line">        //注册将GlideUrl转成输入流的图片加载器工厂类</span><br><span class="line">        .append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</span><br><span class="line">        //注册将byte[]转成字节缓冲的图片加载器工厂类</span><br><span class="line">        .append(byte[].class, ByteBuffer.class, new ByteArrayLoader.ByteBufferFactory())</span><br><span class="line">        //注册将byte[]转成输入流的图片加载器工厂类</span><br><span class="line">        .append(byte[].class, InputStream.class, new ByteArrayLoader.StreamFactory())</span><br><span class="line">        //注册将Uri转成Uri的图片加载器工厂类</span><br><span class="line">        .append(Uri.class, Uri.class, UnitModelLoader.Factory.&lt;Uri&gt;getInstance())</span><br><span class="line">        //注册将Drawable转成Drawable的图片加载器工厂类</span><br><span class="line">        .append(Drawable.class, Drawable.class, UnitModelLoader.Factory.&lt;Drawable&gt;getInstance())</span><br><span class="line">        //注册将Drawable转成Drawable的解码器</span><br><span class="line">        .append(Drawable.class, Drawable.class, new UnitDrawableDecoder())</span><br><span class="line">        /* Transcoders */</span><br><span class="line">        //注册将Bitmap转换成BitmapDrawable的转换器</span><br><span class="line">        .register(</span><br><span class="line">            Bitmap.class,</span><br><span class="line">            BitmapDrawable.class,</span><br><span class="line">            new BitmapDrawableTranscoder(resources))</span><br><span class="line">        //注册将bitmap转换成byte[]的转码器</span><br><span class="line">        .register(Bitmap.class, byte[].class, bitmapBytesTranscoder)</span><br><span class="line">        //注册将Drawable转成byte[]的转码器</span><br><span class="line">        .register(</span><br><span class="line">            Drawable.class,</span><br><span class="line">            byte[].class,</span><br><span class="line">            new DrawableBytesTranscoder(</span><br><span class="line">                bitmapPool, bitmapBytesTranscoder, gifDrawableBytesTranscoder))转换器</span><br><span class="line">        //注册将gift转换成byte[]的转码器</span><br><span class="line">        .register(GifDrawable.class, byte[].class, gifDrawableBytesTranscoder);</span><br><span class="line">    //创建ImageView包裹类，主要用于图片加载成功设置图片、获取图片大小等</span><br><span class="line">    ImageViewTargetFactory imageViewTargetFactory = new ImageViewTargetFactory();</span><br><span class="line">    //创建专属Glide的上下文</span><br><span class="line">    glideContext =</span><br><span class="line">        new GlideContext(</span><br><span class="line">            context,</span><br><span class="line">            arrayPool,</span><br><span class="line">            registry,</span><br><span class="line">            imageViewTargetFactory,</span><br><span class="line">            defaultRequestOptions,</span><br><span class="line">            defaultTransitionOptions,</span><br><span class="line">            engine,</span><br><span class="line">            logLevel);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public GlideContext(</span><br><span class="line">    @NonNull Context context,</span><br><span class="line">    @NonNull ArrayPool arrayPool,</span><br><span class="line">    @NonNull Registry registry,</span><br><span class="line">    @NonNull ImageViewTargetFactory imageViewTargetFactory,</span><br><span class="line">    @NonNull RequestOptionsFactory defaultRequestOptionsFactory,</span><br><span class="line">    @NonNull Map&lt;Class&lt;?&gt;, TransitionOptions&lt;?, ?&gt;&gt; defaultTransitionOptions,</span><br><span class="line">    @NonNull List&lt;RequestListener&lt;Object&gt;&gt; defaultRequestListeners,</span><br><span class="line">    @NonNull Engine engine,</span><br><span class="line">    boolean isLoggingRequestOriginsEnabled,</span><br><span class="line">    int logLevel) &#123;</span><br><span class="line">  super(context.getApplicationContext());</span><br><span class="line">  this.arrayPool = arrayPool;</span><br><span class="line">  this.registry = registry;</span><br><span class="line">  this.imageViewTargetFactory = imageViewTargetFactory;</span><br><span class="line">  this.defaultRequestOptionsFactory = defaultRequestOptionsFactory;</span><br><span class="line">  this.defaultRequestListeners = defaultRequestListeners;</span><br><span class="line">  this.defaultTransitionOptions = defaultTransitionOptions;</span><br><span class="line">  this.engine = engine;</span><br><span class="line">  this.isLoggingRequestOriginsEnabled = isLoggingRequestOriginsEnabled;</span><br><span class="line">  this.logLevel = logLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2、RequestManagerRetriever获取RequestManager"><a href="#2、RequestManagerRetriever获取RequestManager" class="headerlink" title="2、RequestManagerRetriever获取RequestManager"></a>2、RequestManagerRetriever获取RequestManager</h2><table>
<thead>
<tr>
<th>方法</th>
</tr>
</thead>
<tbody><tr>
<td>get(Context)</td>
</tr>
<tr>
<td>get(Activity)</td>
</tr>
<tr>
<td>get(FragmentActivity)</td>
</tr>
<tr>
<td>get(androidx.fragment.app.Fragment)</td>
</tr>
<tr>
<td>get(android.app.Fragment)</td>
</tr>
<tr>
<td>get(View)</td>
</tr>
</tbody></table>
<p>总结一下Glide初始化的流程：<br>    •    解析注解定义的AppGlideModule或者Manifest定义的GlideModule，将其对应的配置信息设置给GlideBuilder<br>    •    GlideBuilder设置一些默认的配置信息，比如网络线程池、磁盘线程池、动画线程池、内存缓存、磁盘缓存等<br>    •    GlideBuilder构建Glide，在创建Glide时注册了各种用于图片加载、解码、编码的图片加载器、图片解码器、图片编码器等<br>    •    将AppGlideModule和GlideModule自定义的图片加载、解码器、编码器注册到Glide中<br>    •    监听Application的生命周期<br>这里Glide的初始化主要使用单例、构建等设计模式</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chaozhouzhang.github.io/2020/01/12/Glide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="张潮州">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张潮州">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/12/Glide/" class="post-title-link" itemprop="url">Glide</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-12 11:32:18" itemprop="dateCreated datePublished" datetime="2020-01-12T11:32:18+08:00">2020-01-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="张潮州"
    src="/images/header.jpeg">
  <p class="site-author-name" itemprop="name">张潮州</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张潮州</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.2
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  


















  

  

  

</body>
</html>
